# Makefile para automaÃ§Ã£o de tarefas do backend (Chefia POS)

.PHONY: help install dev-install format lint typecheck test clean setup-hooks run all ci-check

# VariÃ¡veis
PYTHON = python3
PIP = pip
SRC_DIR = .
TEST_DIR = tests

# Help
help:
	@echo "Comandos disponÃ­veis:"
	@echo "  install      - Instalar dependÃªncias de produÃ§Ã£o (poetry)"
	@echo "  dev-install  - Instalar dependÃªncias de desenvolvimento"
	@echo "  format       - Formatar cÃ³digo (black + ruff)"
	@echo "  format-check - Verificar formataÃ§Ã£o sem alterar arquivos"
	@echo "  lint         - Executar linting (ruff)"
	@echo "  typecheck    - Verificar tipos (mypy)"
	@echo "  test         - Executar testes (pytest)"
	@echo "  test-cov     - Executar testes com coverage"
	@echo "  clean        - Limpar arquivos temporÃ¡rios"
	@echo "  setup-hooks  - Configurar pre-commit hooks"
	@echo "  run          - Executar aplicaÃ§Ã£o"
	@echo "  run-dev      - Executar aplicaÃ§Ã£o em modo desenvolvimento"
	@echo "  all          - Formatar, lint, typecheck e testar"
	@echo "  ci-check     - VerificaÃ§Ã£o completa do CI"

# InstalaÃ§Ã£o
install:
	poetry install --no-dev

dev-install: install
	poetry install
	poetry add --group dev pre-commit

# FormataÃ§Ã£o
format:
	@echo "ğŸ“ Formatando com black..."
	poetry run black $(SRC_DIR)
	@echo "ğŸ”§ Aplicando ruff fix..."
	poetry run ruff check $(SRC_DIR) --fix
	@echo "âœ… FormataÃ§Ã£o concluÃ­da!"

# Verificar formataÃ§Ã£o sem alterar
format-check:
	@echo "ğŸ“‹ Verificando formataÃ§Ã£o..."
	poetry run black --check $(SRC_DIR)
	poetry run ruff check $(SRC_DIR)
	@echo "âœ… VerificaÃ§Ã£o de formataÃ§Ã£o concluÃ­da!"

# Linting
lint:
	@echo "ğŸ” Executando ruff..."
	poetry run ruff check $(SRC_DIR)
	@echo "âœ… Linting concluÃ­do!"

# Type checking
typecheck:
	@echo "ğŸ” Executando mypy..."
	poetry run mypy $(SRC_DIR) --ignore-missing-imports
	@echo "âœ… Type checking concluÃ­do!"

# Testes
test:
	@echo "ğŸ§ª Executando testes..."
	poetry run pytest $(TEST_DIR) -v

test-cov:
	@echo "ğŸ§ª Executando testes com coverage..."
	poetry run pytest $(TEST_DIR) --cov=$(SRC_DIR) --cov-report=html --cov-report=term-missing

# Limpeza
clean:
	@echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.pyd" -delete
	find . -type f -name ".coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Limpeza concluÃ­da!"

# Configurar hooks
setup-hooks:
	@echo "âš™ï¸ Configurando pre-commit hooks..."
	poetry run pre-commit install
	poetry run pre-commit install --hook-type commit-msg
	@echo "âœ… Hooks configurados!"

# Executar aplicaÃ§Ã£o
run:
	@echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
	poetry run uvicorn main:app --host 0.0.0.0 --port 8001

run-dev:
	@echo "ğŸš€ Iniciando aplicaÃ§Ã£o em modo desenvolvimento..."
	poetry run uvicorn main:app --host 0.0.0.0 --port 8001 --reload

# Comando completo
all: format lint typecheck test
	@echo "âœ… Todas as verificaÃ§Ãµes passaram!"

# VerificaÃ§Ã£o completa do CI
ci-check: format-check lint typecheck test
	@echo "âœ… VerificaÃ§Ã£o completa do CI passou!"

# ConfiguraÃ§Ã£o inicial do projeto
setup: dev-install setup-hooks
	@echo "âœ… Projeto configurado com sucesso!"
	@echo "ğŸ’¡ Execute 'make format' para formatar o cÃ³digo"
	@echo "ğŸ’¡ Execute 'make run-dev' para iniciar o desenvolvimento"